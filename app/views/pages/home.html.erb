<div class="home-container">
  <div class="home-card" data-controller="copy-values">
    <div class="calculator-form-container" data-controller="calculator">
      <h3 class="trade-form-title">
        <i class="bi bi-calculator"></i>
        Yield do Prêmio
      </h3>
      <div class="trade-form">
        <div class="trade-form-row">
          <div class="trade-form-group">
            <label class="trade-label">Strike</label>
            <input
              type="text"
              class="trade-input"
              placeholder="0,00"
              data-calculator-target="strike"
              data-copy-values-target="strikeSource"
              data-action="input->calculator#formatInput input->calculator#calculate"
              >
            </div>
            <div class="trade-form-group">
              <label class="trade-label">Prêmio</label>
              <input
              type="text"
              class="trade-input"
              placeholder="0,00"
              data-calculator-target="premium"
              data-copy-values-target="premiumSource"
              data-action="input->calculator#formatInput input->calculator#calculate"
                >
              </div>
              <div class="trade-form-group trade-form-group-centered">
                <label class="trade-label">Yield</label>
                <div style="display: flex; gap: 8px; align-items: center;">
                  <div class="trade-input" data-calculator-target="result" style="background-color: #f5f5f5; flex: 1;">0.00%</div>
                  <button
                    type="button"
                    class="trade-copy-btn"
                    data-action="click->copy-values#copy"
                    title="Copiar para operação">
                    <i class="bi bi-arrow-down-circle"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
        <% if user_signed_in? %>
          <div class="trade-form-container">
            <h3 class="trade-form-title">
              <i class="bi bi-plus-circle"></i>
              Operação
            </h3>
            <div id="flash_messages"></div>
            <%= simple_form_for @option_trade, url: option_trades_path, html: { class: 'trade-form', id: 'option_trade_form', data: { controller: 'autofill-trade', autofill_trade_url_value: search_by_code_path } } do |f| %>
              <div class="trade-form-row">
                <div class="trade-form-group">
                  <%= f.input :trade_date,
                            as: :string,
                            wrapper: false,
                            required: false,
                            label_html: { class: 'trade-label' },
                            input_html: {
                              class: 'trade-input',
                              placeholder: 'DD/MM/AA',
                              data: {
                                controller: 'date-input',
                                date_input_auto_fill_value: true,
                                action: 'input->date-input#input paste->date-input#paste blur->date-input#blur'
                              }
                            } %>
                </div>
                <div class="trade-form-group">
                  <%= f.input :operation_type,
                            collection: [['Compra', 'buy'], ['Venda', 'sell']],
                            selected: 'sell',
                            wrapper: false,
                            required: false,
                            label_html: { class: 'trade-label' },
                            input_html: { class: 'trade-input' } %>
                </div>
                <div class="trade-form-group">
                  <%= f.input :option_type,
                            collection: [['CALL', 'call'], ['PUT', 'put']],
                            selected: 'put',
                            wrapper: false,
                            required: false,
                            label_html: { class: 'trade-label' },
                            input_html: { class: 'trade-input' } %>
                </div>
              </div>
              <div class="trade-form-row">
                <div class="trade-form-group">
                  <%= f.input :quantity,
                            as: :string,
                            wrapper: false,
                            required: false,
                            label_html: { class: 'trade-label' },
                            input_html: {
                              class: 'trade-input',
                              placeholder: '100',
                              data: {
                                controller: 'integer-input',
                                action: 'input->integer-input#input paste->integer-input#paste'
                              }
                            } %>
                </div>
                <div class="trade-form-group">
                  <%= f.input :option_code,
                            wrapper: false,
                            required: false,
                            label_html: { class: 'trade-label' },
                            input_html: {
                              class: 'trade-input',
                              placeholder: 'Ex: PETRC50',
                              data: {
                                controller: 'option-code',
                                autofill_trade_target: 'optionCode',
                                action: 'input->option-code#input input->autofill-trade#search paste->option-code#paste'
                              }
                            } %>
                </div>
                <div class="trade-form-group">
                  <%= f.input :strike_price,
                            as: :string,
                            wrapper: false,
                            required: false,
                            label_html: { class: 'trade-label' },
                            input_html: {
                              class: 'trade-input',
                              placeholder: '0,00',
                              data: {
                                controller: 'currency-input',
                                copy_values_target: 'strikeDestination',
                                autofill_trade_target: 'strikePrice',
                                action: 'input->currency-input#input paste->currency-input#paste'
                              }
                            } %>
                </div>
              </div>
              <div class="trade-form-row">
                <div class="trade-form-group">
                  <%= f.input :premium,
                            as: :string,
                            wrapper: false,
                            required: false,
                            label_html: { class: 'trade-label' },
                            input_html: {
                              class: 'trade-input',
                              placeholder: '0,00',
                              data: {
                                controller: 'currency-input',
                                copy_values_target: 'premiumDestination',
                                action: 'input->currency-input#input paste->currency-input#paste'
                              }
                            } %>
                </div>
                <div class="trade-form-group">
                  <%= f.input :expiration_date,
                            as: :string,
                            wrapper: false,
                            required: false,
                            label_html: { class: 'trade-label' },
                            input_html: {
                              class: 'trade-input',
                              placeholder: 'DD/MM/AA',
                              data: {
                                controller: 'date-input',
                                autofill_trade_target: 'expirationDate',
                                action: 'input->date-input#input paste->date-input#paste'
                              }
                            } %>
                </div>
                <div class="trade-form-group">
                  <%= f.input :underlying_asset,
                            wrapper: false,
                            required: false,
                            label_html: { class: 'trade-label' },
                            input_html: { class: 'trade-input', placeholder: 'Ex: PETR4', data: {
                              controller: 'option-code',
                              autofill_trade_target: 'underlyingAsset',
                              action: 'input->option-code#input paste->option-code#paste'
                            } } %>
                </div>
              </div>
              <div class="trade-form-actions">
                <%= f.button :submit, "Registrar Operação", class: "trade-submit-btn" %>
              </div>
            <% end %>
          </div>
        <% end %>
        <div class="trades-list-container">
          <div class="search-container">
            <%= form_with(url: root_path, method: :get, class: "search-form", data: { turbo: false }) do |f| %>
              <div class="search-wrapper">
                <%= f.text_field :q,
                    value: params[:q],
                    placeholder: "Buscar por ativo ou código da opção...",
                    class: "search-input" %>
                <%= f.submit "Buscar", class: "search-btn" %>
                <% if params[:q].present? %>
                  <%= link_to "Limpar", root_path, class: "clear-btn" %>
                <% end %>
              </div>
            <% end %>
          </div>
          <div class="controls-wrapper">
            <div class="filter-container" data-controller="sort">
            <button type="button" class="filter-toggle-btn" data-action="click->sort#toggle">
              <i class="bi bi-funnel"></i>
              <span>Filtrar por</span>
              <i class="bi bi-chevron-down" data-sort-target="chevron"></i>
              <%
                active_filters = 0
                active_filters += 1 if params.dig(:filter, :trade_date_start).present? || params.dig(:filter, :trade_date_end).present?
                active_filters += 1 if params.dig(:filter, :operation_type).present?
                active_filters += 1 if params.dig(:filter, :option_type).present?
                active_filters += 1 if params.dig(:filter, :underlying_asset).present?
                active_filters += 1 if params.dig(:filter, :expiration_date_start).present? || params.dig(:filter, :expiration_date_end).present?
              %>
              <% if active_filters > 0 %>
                <span class="filter-badge"><%= active_filters %></span>
              <% end %>
            </button>

            <div class="filter-content" data-sort-target="content">
              <%= form_with(url: root_path, method: :get, class: "filter-form", data: { turbo: false }) do |f| %>
                <%= f.hidden_field :q, value: params[:q] if params[:q].present? %>
                <% params[:sort]&.each do |key, value| %>
                  <%= hidden_field_tag "sort[#{key}]", value %>
                <% end %>

                <div class="filter-fields-list">
                  <div class="filter-field-group">
                    <label class="filter-group-label">Data</label>
                    <div class="filter-date-range">
                      <%= text_field_tag "filter[trade_date_start]",
                          params.dig(:filter, :trade_date_start),
                          placeholder: "DD/MM/AA",
                          class: "filter-input filter-date",
                          data: {
                            controller: 'date-input',
                            action: 'input->date-input#input paste->date-input#paste'
                          } %>
                      <span class="filter-separator">até</span>
                      <%= text_field_tag "filter[trade_date_end]",
                          params.dig(:filter, :trade_date_end),
                          placeholder: "DD/MM/AA",
                          class: "filter-input filter-date",
                          data: {
                            controller: 'date-input',
                            action: 'input->date-input#input paste->date-input#paste'
                          } %>
                    </div>
                  </div>

                  <div class="filter-field-group">
                    <label class="filter-group-label">Operação</label>
                    <%= select_tag "filter[operation_type]",
                        options_for_select([["Todos", ""], ["Compra", "buy"], ["Venda", "sell"]], params.dig(:filter, :operation_type)),
                        class: "filter-select" %>
                  </div>

                  <div class="filter-field-group">
                    <label class="filter-group-label">Tipo</label>
                    <%= select_tag "filter[option_type]",
                        options_for_select([["Todos", ""], ["CALL", "call"], ["PUT", "put"]], params.dig(:filter, :option_type)),
                        class: "filter-select" %>
                  </div>

                  <div class="filter-field-group">
                    <label class="filter-group-label">Ativo</label>
                    <%= text_field_tag "filter[underlying_asset]",
                        params.dig(:filter, :underlying_asset),
                        placeholder: "Ex: PETR4",
                        class: "filter-input",
                        data: {
                          controller: 'option-code',
                          action: 'input->option-code#input paste->option-code#paste'
                        } %>
                  </div>

                  <div class="filter-field-group">
                    <label class="filter-group-label">Vencimento</label>
                    <div class="filter-date-range">
                      <%= text_field_tag "filter[expiration_date_start]",
                          params.dig(:filter, :expiration_date_start),
                          placeholder: "DD/MM/AA",
                          class: "filter-input filter-date",
                          data: {
                            controller: 'date-input',
                            action: 'input->date-input#input paste->date-input#paste'
                          } %>
                      <span class="filter-separator">até</span>
                      <%= text_field_tag "filter[expiration_date_end]",
                          params.dig(:filter, :expiration_date_end),
                          placeholder: "DD/MM/AA",
                          class: "filter-input filter-date",
                          data: {
                            controller: 'date-input',
                            action: 'input->date-input#input paste->date-input#paste'
                          } %>
                    </div>
                  </div>
                </div>

                <div class="filter-actions">
                  <%= f.submit "Aplicar", class: "search-btn" %>
                  <% if active_filters > 0 %>
                    <%= link_to "Limpar", root_path(q: params[:q], sort: params[:sort]&.to_unsafe_h), class: "clear-btn" %>
                  <% end %>
                </div>
              <% end %>
            </div>
          </div>

          <div class="sort-container" data-controller="sort">
            <button type="button" class="sort-toggle-btn" data-action="click->sort#toggle">
              <i class="bi bi-sort-down"></i>
              <span>Ordenar por</span>
              <i class="bi bi-chevron-down" data-sort-target="chevron"></i>
              <% if params[:sort].present? %>
                <span class="sort-badge"><%= params[:sort].keys.length %></span>
              <% end %>
            </button>
            <div class="sort-content" data-sort-target="content">
              <%= form_with(url: root_path, method: :get, class: "sort-form", data: { turbo: false }) do |f| %>
                <%= f.hidden_field :q, value: params[:q] if params[:q].present? %>
                <% params[:filter]&.each do |key, value| %>
                  <%= hidden_field_tag "filter[#{key}]", value %>
                <% end %>
                <div class="sort-fields-list">
                  <div class="sort-field-item">
                    <label class="sort-label">
                      <%= check_box_tag "sort[trade_date]",
                          params.dig(:sort, :trade_date) || "desc",
                          params.dig(:sort, :trade_date).present?,
                          class: "sort-checkbox",
                          data: { action: "change->sort#toggleField" } %>
                      <span>Data</span>
                    </label>
                    <%= select_tag "sort[trade_date]",
                        options_for_select([["↓ Decrescente", "desc"], ["↑ Crescente", "asc"]], params.dig(:sort, :trade_date) || "desc"),
                        class: "sort-select",
                        disabled: params.dig(:sort, :trade_date).blank? %>
                  </div>

                  <div class="sort-field-item">
                    <label class="sort-label">
                      <%= check_box_tag "sort[option_code]",
                          params.dig(:sort, :option_code) || "asc",
                          params.dig(:sort, :option_code).present?,
                          class: "sort-checkbox",
                          data: { action: "change->sort#toggleField" } %>
                      <span>Código</span>
                    </label>
                    <%= select_tag "sort[option_code]",
                        options_for_select([["A→Z", "asc"], ["Z→A", "desc"]], params.dig(:sort, :option_code) || "asc"),
                        class: "sort-select",
                        disabled: params.dig(:sort, :option_code).blank? %>
                  </div>

                  <div class="sort-field-item">
                    <label class="sort-label">
                      <%= check_box_tag "sort[expiration_date]",
                          params.dig(:sort, :expiration_date) || "asc",
                          params.dig(:sort, :expiration_date).present?,
                          class: "sort-checkbox",
                          data: { action: "change->sort#toggleField" } %>
                      <span>Vencimento</span>
                    </label>
                    <%= select_tag "sort[expiration_date]",
                        options_for_select([["↑ Crescente", "asc"], ["↓ Decrescente", "desc"]], params.dig(:sort, :expiration_date) || "asc"),
                        class: "sort-select",
                        disabled: params.dig(:sort, :expiration_date).blank? %>
                  </div>

                  <div class="sort-field-item">
                    <label class="sort-label">
                      <%= check_box_tag "sort[notional]",
                          params.dig(:sort, :notional) || "desc",
                          params.dig(:sort, :notional).present?,
                          class: "sort-checkbox",
                          data: { action: "change->sort#toggleField" } %>
                      <span>Notional</span>
                    </label>
                    <%= select_tag "sort[notional]",
                        options_for_select([["↓ Decrescente", "desc"], ["↑ Crescente", "asc"]], params.dig(:sort, :notional) || "desc"),
                        class: "sort-select",
                        disabled: params.dig(:sort, :notional).blank? %>
                  </div>
                </div>
                <div class="sort-actions">
                  <%= f.submit "Aplicar", class: "search-btn" %>
                  <% if params[:sort].present? %>
                    <%= link_to "Limpar", root_path(q: params[:q], filter: params[:filter]&.to_unsafe_h), class: "clear-btn" %>
                  <% end %>
                </div>
              <% end %>
            </div>
          </div>
          </div>

          <div class="trades-table-wrapper">
            <table class="trades-table">
              <thead>
                <tr>
                  <th>Data</th>
                  <th>Operação</th>
                  <th>Código</th>
                  <th>Tipo</th>
                  <th>Qtd</th>
                  <th>Strike</th>
                  <th>Prêmio</th>
                  <th>Yield</th>
                  <th>Total</th>
                  <th>Vencimento</th>
                  <th>Notional</th>
                </tr>
              </thead>
              <tbody id="option_trades_tbody">
                <% if @option_trades.present? %>
                  <% @option_trades.each do |trade| %>
                    <%= render partial: "option_trades/option_trade_row", locals: { option_trade: trade } %>
                  <% end %>
                <% end %>
              </tbody>
            </table>
          </div>

          <% if @option_trades.present? %>
            <div class="pagination-container">
              <%= paginate @option_trades %>
            </div>
          <% end %>
        </div>
      </div>
    </div>
